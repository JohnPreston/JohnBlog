<p>There are two types of instances : Instance-Store and EBS-Backend. As you will be able to see here (<a class="reference external" href="http://url-vers-explication-ebs-instancestrore">http://url-vers-explication-ebs-instancestrore</a>) EBS give you the capacity to keep your datas on SAN, to stop / start a VM without loosing datas. But there is no &quot;3 Clicks&quot; way to have one today. So here we are going to see an easy and sure way to create your EBS EMIs.</p>
<div class="section" id="requirements">
<h2>Requirements</h2>
<p>Of course, you will need to have a working Eucalyptus Cloud. It seems obviouis that you have enough compute capacity to run new instances and enough hard drive free space to create EBS and snapshots. Depending on your platform, some steps may be long.</p>
<p>Let's check some cloud-properties and status :</p>
<pre class="code bash literal-block">
admin&#64;clc-0 <span class="nv">$&gt;</span>euca-describe-services -E <span class="c"># here we check that all the Eucalyptus components are running and registred
</span>admin&#64;clc-0 <span class="nv">$&gt;</span>euca-describe-properties
admin&#64;clc-0 <span class="nv">$&gt;</span>euca-create-volume -s 5 -z cluster <span class="c"># here we test that EBS creation is working properly</span>
</pre>
<p>The services must be all enabled and let's understand some cloud-properties for our needs :</p>
<ul class="simple">
<li>cluster.storage.maxtotalvolumesizeingb : This is the size allocated for all EBS volumes</li>
<li>cluster.storage.maxvolumesizeingb : This is the maximum size of 1 EBS volume (default: 15Go)<ul>
<li><em>You will have to change this property if you want to create more thant 15 Go EBS volumes</em></li>
</ul>
</li>
<li>cluster.storage.shouldtransfersnapshots : Defines if your snapshots should also be transfered in S3 Walrus. (default: True)<ul>
<li><em>This will allow you to &quot;distribute&quot; all your EMIs across regions easily. But This will take more time to create the snapshot.</em></li>
</ul>
</li>
<li>walrus.storagemaxtotalsnapshotsizeingb : This is the maximum size allocated for all your snapshots</li>
</ul>
</div>
<div class="section" id="original-vm">
<h2>Original VM</h2>
<p>Most of people want to do an EBS EMI from an Instance-Store one. I am not part of these people. I prefer to fully create an instance from my own. There are ways :</p>
<ul class="simple">
<li>You have physical access to the NC, and the capacity to use and external medium (USB CD/DVD Reader - USB Key) to boot on and setup the OS</li>
<li>You do not have physical access but you have SSH access to it and your client has graphical X Server (You can also use XMing for Windows).</li>
<li>The computer you are working with supports virtualization.</li>
</ul>
<div class="section" id="first-case">
<h3>First case</h3>
<p>Here, we only have to create a volume, snapshot it and register an EMI. Then run a new instance. Obviously, no OS on the EBS. But thanks to the USB Device, you can add a PCI device on the fly, and declare to boot from it. Then, do your setup. When OS setup finished, you have your VM. Stop it, snapshot the root device and re-create an EMI.</p>
<div class="attention">
<p class="first admonition-title">Attention!</p>
<p class="last">You will need to use the init scripts provided by Eucalyptus or create your own to have SSH-Key based access and other functions.</p>
</div>
</div>
<div class="section" id="second-case">
<h3>Second case</h3>
<p>We now need an Instance (an instance-store one). This one will allow us to use our EBS in the future. Will eustore, download one and run it :</p>
<pre class="code bash literal-block">
admin&#64;clc-0 <span class="nv">$&gt;</span>eustore-describe-images
admin&#64;clc-0 <span class="nv">$&gt;</span>eustore-install-image --help
admin&#64;clc-0 <span class="nv">$&gt;</span>euca-run-instances <span class="nv">$EMI</span> -n <span class="nv">$number</span> -k <span class="nv">$KEY</span> -t <span class="nv">$instance</span>-size -g <span class="nv">$group</span>
</pre>
<p>I do advice you to create specific Security Groups depending on your Instance usage.</p>
<div class="section" id="use-virt-manager">
<h4>Use virt-manager</h4>
<p>I am a shell guy, mean I do everything in shell windows, but it is also true to say that GUI have a lot of benefits. Here, what we are going to do is to use virt-manager. It is a very powerful tool to manage KVM / XEN on remote and redirect all through SSH. So, here I am on a CentOS client with graphical interface. Be sure to have ssh access to your NC.</p>
<div class="section" id="before-creating-our-vm">
<h5>Before creating our VM</h5>
<p>I advice you to enable graphical access (via VNC) to the VM created by Eucalyptus. To do so, uncomment vnc section in /etc/eucalyptus/libvirt.xsl :</p>
<pre class="code xml literal-block">
<span class="nt">&lt;graphics</span> <span class="na">type=</span><span class="s">'vnc'</span> <span class="na">port=</span><span class="s">'-1'</span> <span class="na">autoport=</span><span class="s">'yes'</span> <span class="na">keymap=</span><span class="s">'en-us'</span><span class="nt">/&gt;</span>
</pre>
<p>Restart the Node controller service (If you have running VMs on it, this <strong>will not</strong> stop them)</p>
<pre class="code bash literal-block">
sudo service eucalyptus-nc restart
</pre>
</div>
<div class="section" id="use-ssh-keys">
<h5>Use ssh-keys</h5>
<p>For any action made by virt-manager, you will be prompted for your password. To avoid this and guarantee a full secured permanent access, use ssh-keys : generate a ssh-key for your current user, then, sync it for the root user on your NC :</p>
<pre class="code bash literal-block">
user&#64;client <span class="nv">$&gt;</span>ssh-keygen -t rsa -b 4096
user&#64;client <span class="nv">$&gt;</span>ssh-copy-id -i <span class="nv">$HOME</span>/.ssh/id_rsa.pub root&#64;node
</pre>
<p>Once it's done, download and setup virt-manager, then, launch it. If you plan to use your own computer (the one you are working with) to create this original VM, do so, otherwise, create a new connection to your NC.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">You will need the ISO of the Operating System you plan to install. On a NC, you should put this in /var/lib/libvirt/images with the correct access rights (libvirt:root)</p>
</div>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">If you plan to create a Windows EMI, get the KVM drivers and kernels. If you do not provide these to windows, you will not be able to detect virtio drives</p>
</div>
</div>
</div>
<div class="section" id="create-on-vm">
<h4>Create on VM</h4>
<p>Here we are ! That's the usual way to install a new operating system. You will be able to assign the values you want to your original VM.</p>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">In /etc/eucalyptus/eucalyptus.conf on your NC, you are using specific VM properties : virtio. Be sure that all devices on the VM you are creating are the same according to this configuration !</p>
</div>
<div class="tip">
<p class="first admonition-title">Tip</p>
<p>Here you will be able to organize your partitions on your will. There are tens way to do so. Here is the right moment to plan your instance according to its usage.</p>
<ul class="last simple">
<li>Classical VM ? :<ul>
<li>Create a /boot, / using most of space and some for the swap</li>
<li>Create a /boot, / using most of space and NO swap : you will use a script which on startup will use part of your ephemeral as a swap device</li>
</ul>
</li>
<li>Heavy storage VM ?<ul>
<li>Create a /boot, and use LVM for the sub parts : in the future, if you need more space, add EBS volumes, and extend LVM ;)</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="prepare-our-fresh-vm-for-eucalyptus">
<h3>Prepare our fresh VM for Eucalyptus</h3>
<p>Our setup is finished, and after reboot we are glad to see our system running properly. But, it is a too specific one. So here we are going to &quot;clean&quot; this VM to be the most generic possible. We also are going to setup all our usual packages.</p>
<div class="section" id="on-linux">
<h4>On linux</h4>
<p>At startup, you system created some &quot;rules&quot; which come from your hardware configuration. We need to delete this, because all the instances you will create from this EMI will have different properties (i.e. the eth0 MAC address). So begin with deleting these rules :</p>
<pre class="code bash literal-block">
rm -rfv /etc/udev/rules.d/* <span class="c"># rules usually are in the same directory for most common distros. Specifyt this path according to yours.</span>
</pre>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">For CentOS or RedHat EMIs, remember to delete the HWADDR property in /etc/sysconfig/network-scripts/ifcfg-eth0 and set BOOTPROTO to dhcp and ONBOOT to yes
On debian based, the HWADDR is usually not set.</p>
</div>
</div>
</div>
</div>
